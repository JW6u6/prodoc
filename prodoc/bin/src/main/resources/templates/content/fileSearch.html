<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="modal">
        <div class="modelBtnList">
            <button class="closeBtn">&#10005;</button>
        </div>
        <div class="search_option">
            <div>
                <input type="text" name="searchWord" placeholder="검색어">
                <button id="fileSearchBtn">검색</button>
            </div>
            <div>
                <input type="date" name="searchDate" id="startDate" disabled> ~ <input type="date" name="searchDate" id="endDate" disabled>
                <button>업로드일</button><br>
                <input type="checkbox" id="checkAll"><span>전체선택</span>
                <input type="checkbox" name="searchOption" value="upName"><span>파일명</span>
                <input type="checkbox" name="searchOption" value="upUser"><span>업로더</span>
                <input type="checkbox" name="searchOption" value="pageName"><span>페이지명</span>
                <input type="checkbox" name="searchOption" value="workName"><span>워크스페이스명</span>
            </div>
        </div>
        
        <div class="searchList">
            <table border="1" id="fileSearchList">
                <thead>
                    <tr>
                        <th>파일명</th>
                        <th>업로더</th>
                        <th>페이지명</th>
                        <th>날짜</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </div>
</body>

<script>
    //모달창 열었을 때 전체 파일 조회
    //getAllList();
    
    //이벤트 등록
    document.getElementById("fileSearchBtn").addEventListener("click", getSearchList);

    // 전체 선택 체크박스
    const checkInput = document.querySelectorAll("input[name='searchOption']");
    document.getElementById("checkAll").addEventListener("click", function(e){
        checkInput.forEach(tag => {
	        if(e.target.checked == false) tag.checked = false;
	        else tag.checked = true;
        })
    });

    checkInput.forEach(tag => {
        tag.addEventListener("change", function(e){
            if(tag.checked == false) document.getElementById("checkAll").checked = false;
        })
    });
    
    // 날짜 버튼 클릭으로 input date 활성화
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");

    endDate.nextElementSibling.addEventListener("click", function(e){
        startDate.disabled = !startDate.disabled;
        endDate.disabled = !endDate.disabled;
    });

    // 날짜 포멧 변경
    function changeDate(dbDate){
    	let date = new Date(dbDate);
    	let year = date.getFullYear();
    	let month = ('0' + (date.getMonth() + 1)).slice(-2);
    	let day = ('0' + date.getDate()).slice(-2);
    	
    	return `${year}-${month}-${day}`;
    };
    
    // 날짜 검색 조건
    startDate.addEventListener("change", function(e){
        if(startDate.value != "") {
            endDate.removeAttribute("disabled");
            endDate.value = startDate.value;
            endDate.setAttribute("min", startDate.value);
        }
    });
    
    
    // 목록 조회 AJAX --------------------------------------------------------------------------------------------
    function getAllList(searchData){
        let fileSearchList = document.querySelector("#fileSearchList tbody");
        fileSearchList.innerHTML = "";    	
    	
        fetch("getFileList", {
            method : "post",
            headers : {
            	"Content-Type" : "application/json"
			},
			body : JSON.stringify(searchData)
        })
        .then(response => response.json())
        .then(result => {
            console.log(result);
            let fileList = result;

            // 태그 생성
            for(let file of fileList){
                let trTag = document.createElement("tr");
                for(let field in file){
                	let value = file[field];
                    if(field == 'displayId'){
                    	trTag.setAttribute('id', file[field]);
                    	continue;
                    };
                    if(field == 'saveDate') value = changeDate(value);
                    let tdTag = document.createElement("td");
                    tdTag.addEventListener("click", getFileInfo);
                    tdTag.innerText = value;
                    trTag.append(tdTag);
                    if(field == 'workName' || field == 'workId' || field == 'pageId'){
                    	tdTag.style.display = 'none';
                    }
                }
                fileSearchList.append(trTag);
            }

        })
        .catch(err => console.log(err))
    }

    // 검색 이벤트
    function getSearchList(e){
        let searchData = {}

        searchData['keyword'] = document.querySelector("input[name='searchWord']").value;  //검색어
        let searchDate = document.querySelectorAll("input[name='searchDate']");     //날짜정보

        // 날짜 태그의 value 가져오기
        for(let date of searchDate){
			console.log(date);            
        	if(date.disabled == true) continue;
			let field = date.getAttribute("id");
			searchData[field] = date.value;
        }

        for(let tag of checkInput){
        	let field = tag.getAttribute("value");
        	searchData[field] = tag.checked;
        }
        
        console.log(searchData);
        getAllList(searchData);
        
    }
    
    // trTag 클릭 이벤트 : fileInfo
    function getFileInfo(e){
    	let displayId = e.currentTarget.parentNode.getAttribute("id");
    	console.log(displayId);
    	
    	fetch("")
    	.then(response => response.json())
    	.then(result => {
    		console.log(result);
    	})
    	.catch(err => console.log(err))
    }

</script>
</html>